# [Observability Engineering](https://www.oreilly.co.jp/books/9784814400126/)

## 第１部：オブザーバビリティへの道

### １章：オブザーバビリティとは？

- オブザーバビリティの意味
  - 制御理論での原義的には、外部出力の知識からシステムの内部状態をどれだけ推測できるかの尺度
  - ソフトウェアシステムの「オブザーバビリティ」：システムがどんな状態でも、その状態をどれだけ理解し説明できるかの尺度
- オブザーバビリティによってできること
  - アプリケーションの内部構造を理解できる
  - 未知の出来事に対しても、アプリケーションがどのようなシステム状態に陥っているか理解できる
  - 外部ツールを通じて観測、調査することで、内部動作とシステム状態を理解する
  - 新たにコードを改修することなく、内部状態を理解できる
- システムがオブザーバビリティを備えているかどうかの問いかけ
  - 任意のユーザーが任意の時間に体験していることを理解できるか？
  - あるユーザーリクエストに疑わしい属性を見つけた時、全てのユーザーを検索して類似のパターンを特定し、疑念を検証できるか？
  - これらの問題に、シームレスに考えを巡らせながら探索的に検証できるか？など
- **新しいコードをデプロイすることなく、システムのどんな斬新な状態も理解できるなら、オブザーバビリティがあると言える**
- オブザーバビリティが必要な理由
  - モニタリングは主に既知の障害モードを想定しており、ソフトウェア開発者はシステムの状態を完全には捉えられない
  - 最近のシステムの実態を把握するには、既存のモニタリングは不十分
	- インフラは動的かつスケーラブルであり、サービスやデータストアが多数存在する
	- ソフトウェアエンジニアは本番環境のコードのオーナーであり、主体的に計装を行い、新しい変更がデプロイされるときにパフォーマンスを検査する動機がある
	- 信頼性の焦点は、エラーバジェットやサービスレベルを利用して、継続的な劣化にどう耐えるかに置かれている
	- 相関関係の検証は、実質的に無制限のディメンジョンの間で行われる
  - モニタリングは既知の未知を扱うが、オブザーバビリティは未知の未知を扱う
- オブザーバビリティの柱：高いカーディナリティ、高いディメンジョン、探索可能性  
  - システムの把握に際して、高いカーディナリティの情報は非常に役に立つ
  - データに豊富なディメンジョンを用意することで、アプリケーションの状態をより精緻に捉えることができる
  - システムの探索可能性：システムが陥った状態に対して、反復的な調査によって最終的な理解が得られること

### ２章：オブザーバビリティとモニタリングにおけるデバック方法の違い

- メトリクスに基づいてシステムの洞察を得ることは、本質的にリアクティブであり、探しているものを事前に宣言する能力によって制限される
- 「多くのチームは、カスタムメトリクスに熱中し、請求書を見て愕然とし、結局その大部分を削除することになるのです」
- オブザーバビリティがあれば、問題がどのように起きているかをディメンジョンの組み合わせによって探索し、原因を発見できる
- 客観的かつ方法論に基づいた調査に注力することで、チーム全体が本番環境の問題を診断する自信にもつながる
- オブザーバビリティツールは、テレメトリーデータから高カーディナリティ、高ディメンジョンのコンテキストを集め、調査者が柔軟に分析できるようにする

### ３章：オブザーバビリティを用いないスケーリングからの教訓

- Parse の事例：その都度最適な技術的選択をしていても、サービスや事業状況の非連続的な変化にシステムが対応しきれないことがある
- モノリス時代の監視ツール（TSDB やログ管理、アラート管理）は、予測可能性が支配している時代のために作られており、マイクロサービスシステムにおけるさまざまな振る舞いの原因を捉えきれない
- システムアーキテクチャの現代化：あらゆるものの分割、多様なデータストア、マイクロサービス化、コンテナやサーバーレスなどエフェメラルでエラスティックなインフラリソースの多用
- システムの分散化に伴う二次的効果：可用性の定義の複雑化、漸進的デリバリー、機能フラグによるコードのデプロイと機能リリースの分離、監視対象における未知の症状の増加
- 分散システムでは、ステージング環境によって本番環境を再現することの難しさも増している。ステージングにおけるデバッグや検査の有用性が薄れている
- 分散システムへの移行における運用プラクティスの変化
  - アラートはユーザー体験に直結するものに焦点を当て、ノイズを抑えていく傾向へ
  - 手順書で対応できるような既知の問題は自律的解決に移行し、エンジニアが対応するべきサービス障害は自動復旧ができない未知の症状となる

### ４章：オブザーバビリティと DevOps、SRE、クラウドネイティブとの関連性

- モノリス時代の監視では、システムコンポーネントの関係を頭に入れておく必要があった。分散トレースによって個々のステップを分解して可視化できれば、特定リクエストの実行に影響を与える要素を理解するだけで良くなる。オブザーバビリティはチームが合理的にデバッグを行うための共有コンテキストを提供する
- DevOps チームや SRE チームはユーザーの苦痛に直結した症状の測定を目指す。症状ベースのモニタリングには、実際の故障を的確に説明する能力が必要となる。
- オブザーバビリティは、DevOps や SRE が実践するようなエンジニアリングプラクティスにも効果的なデータを与える
  - カオスエンジニアリングと継続的検証：システムの基本状態を把握し、カオス注入時の動作や逸脱を説明する能力のために、オブザーバビリティが有用となる
  - 機能フラグ：本番環境において、各機能フラグがユーザーに与える個別的、総合的な影響を把握するためにオブザーバビリティが有用となる
  - 漸進的リリース：システムの振る舞いとリリースの因果関係を効果的に把握するために、オブザーバビリティが有用となる
  - インシデント分析とポストモーテム：事後的な証跡と、振り返り作業者の手がかりを適切に提供するために、オブザーバビリティが有用となる

## 第２部：オブザーバビリティの基礎

### ５章：構造化イベントはオブザーバビリティの構成要素である

- 構造化イベント：ある特定のリクエストがサービスとやりとりしている間に発生した全ての記録
- 高いカーディナリティと高いディメンジョンを提供するためには、イベントは任意にワイドである必要がある。スキーマを使ったり、データ型や形状に制限を加えることはオブザーバビリティの目標とは直行してしまう。

### ６章：イベントをトレースにつなぐ

- トレースを実装するための基本的なデータ：トレースID、スパンID、親ID、タイムスタンプ、継続時間、サービス名、スパン名
- トレースデータを他のサービスに渡すために、HTTP ヘッダーを使う。[W3C トレースコンテキスト](https://www.w3.org/TR/trace-context/)や [B3 標準](https://github.com/openzipkin/b3-propagation)などに従う
  - 例えば B3 標準なら `X-B3-TraceId` がトレース ID、`X-B3-ParentSpanId` が親スパン ID として渡される
- トレース ID の作成や受け渡し、紐付けなどといった計装は、実際には OpenTelemetry などのツールを用いることが多い
- トレースのコンセプトは、RPC を作成するだけでなく、相互に関連するシステム内のあらゆる個別のイベントにも適用できる

### ７章：OpenTelemetry を使った計装

- OpenTelemetry の概念：API（ライブラリの使用部分）、SDK（具体的な実装部分。状態を追跡し、データをバッチ処理して送信する）
  - トレーサー：SDK 内のコンポーネント。プロセス内でアクティブなスパンを追跡、編集、終了する役割
  - メーター：SDK 内のコンポーネント。メトリクスの追跡などの役割
  - コンテキスト伝播：SDK の重要な部分。W3C の TraceContext や B3M のヘッダーからコンテキストをデシリアライズし、トレース内で伝播する役割
  - エクスポーター：SDK のプラグインの一つ。Otel のインメモリオブジェクトを、特定の宛先に送信する
  - コレクター：プロキシやサイドカーとして実行できるプロセス。テレメトリーデータを受信、処理、複数の宛先に転送できる
- OpenTelemetry は、各言語のサービス間通信のフレームワークに対してラッパーやインターセプター、OpenTelemetry エージェントが計装するためにフックできるミドルウェアを提供している
- カスタム計装：サービス間通信の自動計装以外にも、アプリケーション内で特に負荷が高かったり、プロセス内部で時間がかかっている箇所にカスタム計装を追加することで、オブザーバビリティをさらに高めることができる
- OpenTelemetry における「コンテキスト」は、「サービス内で起こるイベントを取り巻く状況」の他に、「トレースのスパンのコンテキスト」のような特定のタイプのコンテキストを指すこともあるので注意
- プロセスやスレッドコンテキストにアクティブなスパンがある場合はどこでも、`sp := trace.SpanFromContext(ctx)` のような形でアクティブなスパンを取得でき、フィールドやイベントを追加できる。
- 計測データをバックエンドに送信するには、OpenTelemetry Collector によってプロキシする方法と、プロセスから直接バックエンドに送る方法がある

### ８章：オブザーバビリティを実現するためのイベント解析

- 間違った文書は、文書がないよりも危険な状態かもしれない。変化の激しいシステムでは、計装そのものが最適なドキュメントとなり得る
- オブザーバビリティを備えることで、体系的かつ着実にシステムの状態を分析することができる
- オブザーバビリティを備えたシステムでは、コア分析ループによって第一原理からシステムの健全性を評価できる
  - 理解したいことの整理→テレメトリーデータを可視化→異常領域に共通するディメンジョンを探す→特定されたディメンジョンから潜在的な異常の原因を考える→理解したいことはの整理→...
- コア分析ループにおける総当たり部分の自動化は APM ツールに任せたい。Cloud Trace はこのあたりの機能や UI がシンプルすぎる気がする。
- 膨大なデータから特徴的なパターンを抽出する作業は機械学習などの自動化ツール、潜在的なパターンや認知的なコンテキストを使った分析は人間が行うべき

### ９章：オブザーバビリティとモニタリングの関係

- モニタリングとメトリクスはリアクティブ（反応的）であり、既知の障害モードに関する未知の状態を警告するために最適化されている
- オブザーバビリティはプロアクティブ（能動的）であり、ユーザーの行動がアプリケーション上でどのように処理されているかを表現している
- ソフトウェアとシステムは、変更頻度や予測可能性など多くの観点で異なる。
  - システム・インフラは比較的予測が容易であり、自動スケールなどのプラクティスも確立されている。健全性評価にはメトリクスによるモニタリングが有効。
  - ソフトウェア（アプリケーション）は変化が多いと同時に顧客の視点が重要となる。健全性を評価するにはオブザーバビリティが有効となる。
  - 例外的に CPU 使用率やメモリ使用量、ディスク使用状況などの高次のインフラメトリクスは、アプリケーションの変更による影響を捉える警告シグナルになり得るため、ソフトウェアの評価観点でも注視すると良い。
- パフォーマンスの問題が発生した際に、システムレベルのメトリクスとアプリケーションのオブザーバビリティデータを並べることは有用となる。
  - 組織のサービス監視環境を構築する上でも、こういったコンテキストを共有できることのメリットは念頭に置きたい

## 第３部：チームのためのオブザーバビリティ

### 10章：オブザーバビリティへの取り組みをチームへ適用する

- TODO

### 11章：オブザーバビリティ駆動開発

- TODO
