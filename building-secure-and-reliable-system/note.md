# [Building Secure and Reliable System](https://www.oreilly.co.jp/books/9784814400256/)

## 第１部：入門資料

### １章：セキュリティと信頼性が交わるところ

- 信頼性にとっての主要なリスク：ソフトウェアの不適切な更新やデバイスの物理的な故障など、悪意がないもの
- セキュリティにとっての主要なリスク：システムの脆弱性を積極的に悪用しようとする攻撃者によってもたらされる
- セキュリティと信頼性は、どちらもシステムの機密性、完全性、可用性に関係している。二つの視点の大きな違いは、悪意のある攻撃者を想定するか否か
- 信頼性とセキュリティの共通点：効力の不可視性、評価方法、単純さの有用性、システムの進化への対応、弾力性、システムの調査とロギング、危機対応など
- インシデントによって企業のバリュエーションを毀損してしまうのは想像しやすい（Yahoo の事例）
- セキュリティと信頼性には多くの共通点があり、どちらも当初は速度の名の下に犠牲にしたくなるが、何かあってから修正するのはコストがかかる

### ２章：攻撃者に対する理解

- 攻撃者のモチベーション：好奇心、名声、金銭的利益、強制、諜報など
- 攻撃者のプロファイル：ホビイスト、脆弱性研究者、政府及び法執行機関、活動家、犯罪当事者、インサイダーなど
  - 政府機関の中には、軍事目的や国内活動の取り締まりなどさまざまなモチベーションがある
- ハードウェアの詳細や暗号など秘匿性の高い情報を扱うサービスは、攻撃者のターゲットとなり得る
- CAPTCHA システムなどを用いることで、攻撃のコストをあげ、攻撃者からの優先度を下げることができる
- 信頼性と安全性を兼ね備えたシステム設計の際には、ミスを犯すかもしれないインサイダーと、従業員のアカウントを乗っ取るかもしれない攻撃者の両方を考慮するのが良い
- インサイダーリスクは、当事者、動機、行動、標的などに応じたモデル化ができる
- インサイダーリスクの分析に効果的な観点：最小権限、ゼロトラスト、マルチパーティ認可、ビジネス上の正当性、監査と検出、リカバリ可能性
- 攻撃者の手法を学ぶための３つのインテリジェンス：脅威インテリジェンス、サイバーキルチェーン、戦術・技術・手順（TTPs）
  - [ARR&CK フレームワーク](https://attack.mitre.org/)はサイバーキルチェーンの各段階を詳細に説明している

## 第２部：システムの設計

### ３章：ケーススタディ：セーフプロキシ

- セーフプロキシは、許可を受けたものが物理サーバーや特定のアプリケーションにアクセスしたり、変更したりすることを可能にする
- セーフプロキシは Google の [Zero Touch Prod](https://www.usenix.org/conference/srecon19emea/presentation/czapinski) プロジェクトを実現するためのツールの一つ
- クライアントが人間か自動ツールかに関わらず、プロキシを利用することでメリットがある
  - マルチパーティ認可（MPA）
  - 管理者による使用状況の監視
  - レート制御
  - サードパーティによるクローズドソースのターゲットシステムとの互換性
  - 継続的な改善の統合
- 一方で、プロキシには欠点や潜在的な落とし穴もある：メンテナンスや運用のオーバーヘッド、構成によっては単一障害点となり得る、アクセス制御のためのポリシー設定自体がエラーの温床となり得る、など
- プロキシ経由によってリモートアクセスの履歴が残るだけでも、管理上有用そう

### ４章：設計におけるトレードオフ

- プロダクトの機能要件は、セキュリティや信頼性の要件とは大きく異なる特性を示す傾向がある
- 機能要件は、要件と対応するコード、それを検証するためのテストなどと具体的に結びつきやすいが、信頼性やセキュリティなどの非機能要件は直接的に実装やテストするのは難しい場合が多い
- 信頼性やセキュリティは、システムの設計や開発・運用に基づく創発特性と言える
  - 信頼性を創発する要因：マイクロサービスの構成、コンポーネント間の通信の仕組み、オブザーバビリティの仕組み
  - セキュリティを創発する要因：システムコンポーネント間の信頼関係、利用される言語・フレームワーク、セキュリティレビューや監査の仕組み
- Google の設計ドキュメントテンプレート：スケーラビリティ、冗長性と信頼性、依存関係への考慮、データ完全性、セキュリティとプライバシーに関する考慮など
- 出来上がったシステムに後からセキュリティや信頼性の要件を足そうとすると、大幅な設計変更や追加の欠陥が含まれる可能性もある。こうした非機能要件は、設計の初期にセキュリティや SRE チームが関与しつつ、そのコストやリスクについてよく考える必要がある
- 信頼性やセキュリティをカバーするための Google の Web アプリケーションフレームワーク、具体的にどんな内容なのか気になる
- 信頼性やセキュリティの検討を後回しにすれば開発の初期速度は上がるが、開発を継続する上での持続速度が上がらなくなってしまう
  - 信頼性に関しては自動テストや CI/CD パイプライン、ロールアウトやロールバックを柔軟に行うためのインフラを整備することで、持続速度を高めることができる
  - セキュリティについては、関連するクラスの脆弱性に対して構造上安全な（secure-by-construction）防御（？）を提供するフレームワークとワークフローを選択するのが良
- ユーザーが利用するプロダクション環境においては信頼性やセキュリティはオプションではない。これらをカバーするための先行投資はよく検討すれば現実的な範囲で収めることもできる。

### ５章：最小権限を前提とする設計

- 最小権限を運用する上では、生産性とセキュリティ、信頼性のバランスを維持して取り組む必要がある
- 最小権限モデルを実装する際のベストプラクティス
  - 小さく機能的な API：API を分割してそれぞれを小さくすることで、特定のアクションに必要なパーミッションを適切に与えることができる
  - 監査：良質な監査ログの収集、監査担当者の選択。監査には大別して「ベストプラクティス遵守の確認のため」と「セキュリティ違反特定のため」の２種類がある
  - テストと最小権限：最小権限のテスト（リソースに付与される権限が必要十分か）と、最小権限でのテスト（テスト実施環境の権限が必要十分か）がある
	- 最小権限でのテストのためのテスト用インフラは小さく始めることができる：環境とクレデンシャルの分離、アクセスタイプの制限、データ露出の制限
  - アクセス拒否の診断：アクセス拒否の要因情報は攻撃者の利益となり得るので、ゼロトラストモデルを実装する初期段階では、トークンを使用し全てのクライアントにサポートチャネルを呼び出させるのが良い
  - グレースフルな障害と非常ボタン：非常ボタンを利用できる権限は厳格に管理する必要がある。その使用の監視も必要となる。
- API へのアクセス制御方法を決定するには、認証と認可が必要になる
- 認可ポリシーは、アプリケーションのバイナリとは独立して更新するのが良い。その際にはアプリケーションの開発者とセキュリティエンジニア・SRE が連携するのが推奨される
- マルチパーティ認可では、間違いの防止や攻撃コストの増加など多くの恩恵がある。一方で要求を拒否するのが精神的に難しい場合は、事後のセキュリティチームへエスカレーションしたり、一部を独立して監査するなどの方法が取れる。
- 最小権限のアクセスモデルは組織のセキュリティ改善に大きく貢献する一方で、実装には一定のコストがかかる。
  - セキュリティ要件として、「あるユーザーはどのサービスやデータにアクセスできるか」などの質問に常に答えられる必要がある
  - 情報の透明性、オープンネスとの兼ね合い
  - 開発者の複雑さを軽減するために、ガイドラインやレビューを設計する必要がある

### ６章：理解しやすさに配慮した設計

- システムの理解しやすさ：「関連する技術的背景を持つ人が次のどちらについても確信をもって正確に推論できる程度」
  - システムの運用上の動作
  - セキュリティと可用性を含む、システムの不変条件
- 理解しやすさのメリット：セキュリティの脆弱性や弾力性障害の低減、効果的なインシデント対応の促進、システムのセキュリティに対するアサーションの信頼性向上
- システムの不変条件：認可されたユーザーだけがデータベースにアクセスできる、機密データへのアクセスは全て監査ログが残る、などの要件（プロパティ）
  - あるプロパティが実際には不変条件ではない場合、そこにはセキュリティ上の弱点や脆弱性があると言える
- 現代のソフトウェアでは、ある程度の複雑さは回避できないことも多い。重要なのは、システムの特定のプロパティの動作を関係者が高い忠実度で推論できること
- ライブラリやフレームワークを用いることで、セキュリティや信頼性に関する共通の要件の責任を一元化できる
- 構造化されたインターフェース、一貫したオブジェクトモデル、冪等な操作は、システムの理解しやすさに直結する
- Google プロダクションシステムのアイデンティティモデル：管理者（Google の開発者）、マシン、ワークロード、カスタマー
- TCB：その障害がセキュリティポリシー違反を起こす可能性のあるコンポーネントの集合
- マイクロサービスをうまく設計することで、特定のセキュリティポリシーに関わる TCB を小さく保つことができる
- ソフトウェアの開発者とレビュアーは、セキュリティと信頼性に関するプロパティのうち、ライブラリやフレームワークが何を保証し、何を保証しないのかを理解する必要がある
- セキュリティや信頼性について望ましいプロパティを適用するための戦略
  - 狭く、一貫し、型付けされたインターフェース
  - 認証、認可、アカウンティングの一貫性があり慎重に実装された戦略
  - ソフトウェアコンポーネントか人間の管理者かを問わない、アクティブエンティティに対するアイデンティティの明確な割り当て
  - セキュリティ不変条件をカプセル化することでコンポーネントがベストプラクティスに一貫して従うことを保証するアプリケーションフレームワークのライブラリとデータ型

### ７章：状況の変化に対応する設計

- セキュリティ体制やセキュリティインフラの弾力性改善のための変更の種類
  - セキュリティインシデントに対応するための変更
  - 新たに発見された脆弱性に対応するための変更
  - プロダクトや機能の変更
  - セキュリティ体制を改善するための内発的に動機づけされた変更
  - 新しい規制要件など、外発的に動機づけられた変更
- あらゆる変更が備えるべき性質：漸進的（≒独立性）、文書化、テスト済み、分離、適格性、段階的（≒カナリア）
- 変更を容易にするアーキテクチャ上の意思決定
  - 依存関係を常に最新の状態に維持して頻繁に再構築
  - テストの自動化を活用して頻繁にリリース
  - コンテナの使用
  - マイクロサービスの使用
	- そもそもマイクロサービスを綺麗に切る必要もある
- クラウド化した世界では、マイクロサービスアーキテクチャを採用し、セキュリティ制御のレイヤー構造を構築し、サービス間の通信をサービスメッシュで管理することで、個別のチームに負担をかけることなく設定の変更ができる
- 変更を適用するのに適した速さは、重大度、依存システムやチーム、感度、機嫌などによって変化する
- ゼロデイ脆弱性への対応
  - ソフトウェアディストリビューションをできる限り標準化する
  - 公開されているディストリビューション標準を使用する
  - 緊急の変更に関して変更プッシュの仕組みを確実に実施できるように準備する
  - ロールアウトの進捗を追跡するためのモニタリング機能があり、パッチが適用されていないシステムを特定できること
  - 非標準であるか、特別な注意が必要なシステムはどれかを把握する
- 中期的にセキュリティと信頼性の文化を構築するための教訓
  - 選択するソリューションが全てのユーザーで機能することを確認する
  - 変更は習得しやすく、できるだけ負担がかからないものにする
  - 中央 IT チームの負担を最小限に抑えるために、変更をセルフサービスで提供する
  - ソリューションが機能し、ユーザーのためになることを明確な証拠で示す
  - ポリシー違反に関するフィードバックループはできるだけ迅速にする
  - 進捗状況を追跡して、ロングテールに対処する方法を判断する
- 長期の計画でリーダー層からの支援を継続的に受けるには、最新の計測とステータスでドキュメンテーションを最新の状態に保つことが重要
- 大規模かつ高速なデプロイへの備え、暗号鍵や他の秘密情報の定期的なローテーションはできるようにしたい

### ８章：弾力性を担保する設計

- 弾力性とリカバリは密接に関係している。リカバリ：壊れた後でシステムの回復する能力。弾力性：破損を遅らせるか、持ち堪える能力
- リクエストの優先順位やコスト、サーバー使用率に基づいて処理を制限（シェディング）することで、サーバーのダウンやカスケード障害の対策となる
- グレースフルデグラデーションを実装する際には、根本要因に関わらずシステムの品質低下のレベルを判断及び記録することで、診断やデバッグに役立つ
- 信頼性を最大化するためには、システムは障害に対して動作し続ける（フェイルオープン、セーフ）ことを目指す。一方でセキュリティを最大化するには、システムは動作を停止する（フェイルクローズド、セキュア）ことになる。
  - 個々のチームがまず、譲れない最小限のセキュリティ体制を決定し、次にセキュリティサービスの重要な機能が必要とする信頼性の提供方法を見つける必要がある
- 爆風半径の制御は、イベントの影響をコンパートメント化することを意味する。攻撃者や偶発障害の両方をコンパートメント化によって封じることで、弾力性を向上できる
- 鍵やクレデンシャルのローテーションによって、攻撃者の能力を時間の経過に応じて制限することができる
- 全ての障害の防止を目的とするのではなく、以下のアプローチを組み合わせることで組織にふさわしいバランスを考えることができる
  - システムを独立した障害ドメインに分割する
  - 単一の根本原因が複数の障害ドメインの要素に影響を及ぼす可能性の低減を目指す
  - 障害発生時に代わりとなりうる冗長なリソース、コンポーネント、手順を作成する
- 障害ドメイン：あるシステムの、同等ながら独立した複数のコピー。どれかに障害が起きても他のコピーは影響を受けない（K8s の Pod とか？）
- サービスの信頼性には、大容量、高可用性、低依存性という３つのクラスののコンポーネントを利用することができる
- システムの信頼性やセキュリティは、現実的かつ制御された方法で定期的に検証する必要がある。検証内容の検討には、バグやインシデントレポート、ファジング、障害注入のアプローチなどが役に立つ
- 弾力性の高いシステムを構築するためには、コストの低い順に以下が考えられる
  - 障害ドメインと爆風半径（＝影響範囲）の制御
  - 高可用性サービスの利用
  - ロードシェディングやスロットリング機能の導入（組織の規模やリスク評価から、弾力性への積極的な投資が正当化される場合）
  - DoS 攻撃に対する防御の有効性評価
  - 低依存性ソリューションの構築と、時間が経っても低依存性が維持されているかの評価プロセスや仕組み
- 弾力性確保に向けた資金や時間が得られた際には、まず最初にすでに導入した弾力性施策のコスト合理化から検討するのが良い
